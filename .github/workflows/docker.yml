name: Java CI/CD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Install Maven
        run: |
          sudo yum install maven -y

      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Build Docker image
        run: docker image build -t examify-server .



  deploy:
    needs: build
    runs-on: [self-hosted]

    steps:
      - name: Start docker
        run:  sudo systemctl start docker

      - name: Check if network exists
        id: check_network
        run: |
            docker network inspect sanjay-network > /dev/null 2>&1 || echo "::set-output name=network_exists::false"

            - name: Create network if it doesn't exist
              if: steps.check_network.outputs.network_exists == 'false'
              run: docker network create sanjay-network

      - name: Pull Image from Docker Hub For Mysql and run container
        run: docker container run --name mysqlcontainer --network sanjay-network -e MYSQL_ROOT_PASSWORD=root -e MYSQL_DATABASE=examifydb -d mysql:8


      - name: Delete old container if exists
        run: docker rm -f examify-server-container || true

      - name: Run Docker container
        run: docker container run --network sanjay-network --name examify-server-container -p 8080:8080 -d examify-server

